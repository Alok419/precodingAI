<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>AI Non-OASIS Analyzer (Unified)</title>
        <style>
    /* --- GLOBAL LAYOUT (Dark Theme) --- */
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b1f2a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #ffffff;
    }

    .card {
        width: 650px; /* Slightly wider to accommodate data */
        background: #081821;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 20px 50px rgba(0,0,0,.45);
        margin: 20px 0;
        position: relative;
        border: 1px solid #1f3a4d;
    }

    h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 0.5px;
        color: #e0e0e0;
    }

    p {
        font-size: 14px;
        opacity: 0.7;
        text-align: center;
        margin-bottom: 25px;
        color: #8daac2;
    }

    /* --- FILE INPUT --- */
    input[type="file"] {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed #4fa3ff;
        background: #06141c;
        color: #fff;
        cursor: pointer;
        box-sizing: border-box;
        margin-bottom: 20px;
        transition: border-color 0.3s;
    }
    input[type="file"]:hover {
        border-color: #7abaff;
    }

    /* --- UPLOAD CARD STYLES --- */
    .upload-card {
        background: linear-gradient(180deg, #0c2230, #081821);
        border: 1px solid #1f3a4d;
        border-radius: 14px;
        padding: 22px;
    }

    .upload-header {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
    }

    .upload-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(79,163,255,0.15);
        color: #7abaff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }

    .upload-title {
        font-size: 15px;
        font-weight: 600;
        color: #e4f1ff;
    }

    .upload-subtitle {
        font-size: 12px;
        color: #9bb9d4;
    }

    .upload-zone {
        border: 2px dashed #355a74;
        border-radius: 12px;
        padding: 26px;
        text-align: center;
        background: #06141c;
        cursor: pointer;
        transition: all 0.25s ease;
        margin-bottom: 16px;
    }

    .upload-zone:hover {
        border-color: #7abaff;
        background: #081d2a;
    }

    .upload-zone-icon {
        font-size: 30px;
        color: #7abaff;
        margin-bottom: 6px;
    }

    .upload-zone-text {
        font-size: 13px;
        font-weight: 600;
        color: #d6eaff;
    }

    .file-section-header {
        font-size: 13px;
        font-weight: 600;
        color: #cfe7ff;
        margin-bottom: 10px;
        display: none;
    }

    /* --- FILE LIST --- */
    .file-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 16px;
    }

    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
        border-radius: 12px;
        padding: 10px 14px;
        border: 1px solid #e6e6e6;
        transition: all 0.2s ease;
    }

    .file-item:hover {
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .file-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
    }

    .file-type-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #eef5ff;
        color: #4fa3ff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .file-meta {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .file-name {
        font-size: 13px;
        font-weight: 600;
        color: #1e1e1e;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 260px;
    }

    .file-size {
        font-size: 11px;
        color: #6b6b6b;
    }

    .remove-btn {
        background: transparent;
        border: none;
        color: #9b9b9b;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .remove-btn:hover {
        background: #ffecec;
        color: #d64545;
    }

    /* --- BUTTONS --- */
    .analyze-btn {
        width: 100%;
        padding: 13px;
        border-radius: 10px;
        background: linear-gradient(135deg, #4fa3ff, #7abaff);
        border: none;
        font-size: 14px;
        font-weight: 600;
        color: #04121a;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .analyze-btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 30px rgba(79,163,255,0.35);
    }

    .analyze-btn:disabled {
        background: #6b6b6b;
        color: #d1d1d1;
    }

    .save-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4cff9f, #27ae60);
        color: #052e16;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        margin-top: 15px;
        cursor: pointer;
    }

    .save-btn:disabled {
        background: #7f8c8d;
        color: #fff;
        cursor: not-allowed;
    }

    /* --- PROGRESS --- */
    .progress-wrapper {
        display: none;
        margin-top: 18px;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #9bb9d4;
        margin-bottom: 6px;
    }

    .progress-container {
        background: #102a3a;
        border-radius: 10px;
        height: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fa3ff, #7abaff);
        transition: width 0.4s ease;
    }

    /* --- RESULTS --- */
    #resultArea {
        display: none;
        margin-top: 25px;
        border-top: 1px solid #1f3a4d;
        padding-top: 20px;
    }
    
    .result-box {
        width: 100%;
        background: #050e13;
        color: #a6e22e;
        border: 1px solid #1f3a4d;
        border-radius: 6px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
        margin-bottom: 15px;
    }

    textarea#jsonOutput { height: 200px; }
    textarea#f2fOutput { height: 100px; color: #ffc107; } /* Yellow for F2F */
    textarea#ptOtOutput { height: 150px; color: #82e0aa; } /* Green tint for PT/OT */

    label {
        font-size: 12px;
        color: #8daac2;
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status {
        margin-top: 15px;
        font-size: 13px;
        text-align: center;
        min-height: 20px;
    }
    .success { color: #4cff9f; }
    .error { color: #ff7a7a; }

    .upload-disabled {
        pointer-events: none;
        opacity: 0.45;
    }
    .upload-disabled * {
        cursor: wait !important;
    }
        </style>
    </head>
    <body>
        <div class="card">
            <h2> Precoding AI </h2>
            <p>Extraction, PT/OT Eval, ICD-10 Audit & F2F</p>
            <div id="loadingMessage" style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500;">
                Connecting to Salesforce...
            </div>
            
            <div id="mainControls" class="upload-card" style="display:none;">
                <div class="upload-header">
                    <div class="upload-icon">üìÑ</div>
                    <div>
                        <div class="upload-title">Upload Clinical Documents</div>
                        <div class="upload-subtitle">
                            Face-to-Face, PT/OT Evals, Encounter Notes
                        </div>
                    </div>
                </div>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <input
                        type="file"
                        id="fileInput"
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                        multiple
                        hidden
                        onchange="handleFileSelect(this)"
                    >
                    <div class="upload-zone-icon">‚¨ÜÔ∏è</div>
                    <div class="upload-zone-text">Click to upload or drag files here</div>
                </div>
                <div id="fileSectionHeader" class="file-section-header">
                    Uploaded Files (<span id="fileCount">0</span>)
                </div>
                <div id="fileListContainer" class="file-list"></div>
                <button id="analyzeBtn" class="analyze-btn" onclick="startAnalysis()">
                    Analyze Documents
                </button>
            </div>
            
            <div id="progressWrapper" class="progress-wrapper">
                <div class="progress-label">
                    <span id="progressText">Analyzing...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div id="status" class="status"></div>
            
            <div id="resultArea">
                <div style="display:block">
                    <label>F2F Encounter Summary:</label>
                    <textarea id="f2fOutput" class="result-box" readonly></textarea>
                    
                    <label>PT/OT Functional Assessment:</label>
                    <textarea id="ptOtOutput" class="result-box" readonly placeholder="Waiting for analysis..."></textarea>
                    
                    <label>Final Audited Result (ICD-10 Compliant):</label>
                    <textarea id="jsonOutput" class="result-box" readonly></textarea>
                </div>
                
                
            </div>
            <button id="saveBtn" class="save-btn" style="display:none" onclick="finalizeSave()">
                    Save Data & Files
                </button>
            
        </div>
        <script>

            function disableUploadUI() {
                document.getElementById("mainControls").classList.add("upload-disabled");
            }

            function enableUploadUI() {
                document.getElementById("mainControls").classList.remove("upload-disabled");
            }

/* =========================================================
   GLOBAL CONTEXT
   ========================================================= */
            
let currentSessionLogs = [];
let CHART_ID = null;
let GEMINI_API_KEY = null;
let SF_SESSION_ID = null;
let SF_BASE_URL = null; 
let VECTOR_STORE_ID = null;
let CACHED_AI_TIME = 0;
let IS_PORTAL = false;

// Array to store actual File objects
let selectedFiles = [];

// Using 2.5 Pro for Vision tasks (Diagnosis, PT/OT) and RAG
const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent"; 
const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent"; 

/* =========================================================
   SALESFORCE CONNECTION
   ========================================================= */

window.addEventListener("message", (event) => {
    if (event.data && event.data.type === "SF_CONTEXT") {
        console.log("‚úÖ Received Context from Salesforce");
        
        CHART_ID = event.data.recordId;
        GEMINI_API_KEY = event.data.apiKey;
        SF_SESSION_ID = event.data.sessionId;
        SF_BASE_URL = event.data.baseUrl;
        VECTOR_STORE_ID = event.data.geminiFileStore;
        IS_PORTAL = event.data.isPortal;
        
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("mainControls").style.display = "block";
    }
});

/* =========================================================
   FILE UI LOGIC
   ========================================================= */

function handleFileSelect(inputElement) {
    if (inputElement.files && inputElement.files.length > 0) {
        for (let i = 0; i < inputElement.files.length; i++) {
            selectedFiles.push(inputElement.files[i]);
        }
        renderFileList();
        inputElement.value = ""; 
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById("fileListContainer");
    const header = document.getElementById("fileSectionHeader");
    const countSpan = document.getElementById("fileCount");

    container.innerHTML = "";

    if (selectedFiles.length === 0) {
        container.style.display = "none";
        header.style.display = "none";
        return;
    }

    header.style.display = "block";
    container.style.display = "flex";
    countSpan.innerText = selectedFiles.length;

    selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";

        const sizeMB = (file.size / 1024 / 1024).toFixed(2);

        item.innerHTML = `
            <div class="file-left">
                <div class="file-type-icon">üìÑ</div>
                <div class="file-meta">
                    <div class="file-name" title="${file.name}">
                        ${file.name}
                    </div>
                    <div class="file-size">
                        ${sizeMB} MB
                    </div>
                </div>
            </div>
            <button class="remove-btn" onclick="removeFile(${index})" title="Remove file">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                </svg>
            </button>
        `;
        container.appendChild(item);
    });
}


/* =========================================================
   PROGRESS BAR HELPER
   ========================================================= */

function updateProgress(percent, text) {
    const wrapper = document.getElementById("progressWrapper");
    const fill = document.getElementById("progressFill");
    const textSpan = document.getElementById("progressText");
    const percentSpan = document.getElementById("progressPercent");

    wrapper.style.display = "block";
    fill.style.width = percent + "%";
    if (text) textSpan.innerText = text;
    percentSpan.innerText = percent + "%";
}

let progressTimer = null;
let progressValue = 1;

function startAutoProgress(target = 90, speed = 120) {
    clearInterval(progressTimer);

    progressTimer = setInterval(() => {
        if (progressValue < target) {
            progressValue++;
            updateProgress(progressValue);
        } else {
            clearInterval(progressTimer);
        }
    }, speed);
}

function stopAutoProgress(finalValue = 100, text = "Complete") {
    clearInterval(progressTimer);
    progressValue = finalValue;
    updateProgress(progressValue, text);
}


/* =========================================================
   MAIN ANALYSIS LOGIC
   ========================================================= */

async function startAnalysis() {
    const analyzeBtn = document.getElementById("analyzeBtn");
    const resultArea = document.getElementById("resultArea");
    const jsonOutput = document.getElementById("jsonOutput");
    const f2fOutput = document.getElementById("f2fOutput");
    const ptOtOutput = document.getElementById("ptOtOutput"); // Added
    
    // UI Reset
    resultArea.style.display = "none";
    jsonOutput.value = "";
    f2fOutput.value = "";
    ptOtOutput.value = ""; // Reset PT/OT
    showStatus(""); 
    
    // Validations
    if (!CHART_ID || !GEMINI_API_KEY) {
        showStatus("‚ùå Configuration missing. Refresh Salesforce page.", true);
        return;
    }

    if (selectedFiles.length === 0) {
        showStatus("‚ùå Please upload at least one file.", true);
        return;
    }
    try {
        analyzeBtn.disabled = true;
        disableUploadUI();
        analyzeBtn.innerText = "Analyzing...";

        // üîµ Start progress
        progressValue = 1;
        updateProgress(1, "Initializing Batch...");
        startAutoProgress(90, 120);

        const startTime = Date.now();

        // --- STEP 1: READ FILES ---
        updateProgress(progressValue, `Processing ${selectedFiles.length} file(s)...`);
        const fileDataArray = await Promise.all(
            selectedFiles.map(file => readFileAsBase64(file))
        );

        // --- STEP 2: PARALLEL AI EXECUTION (Diagnosis, F2F, and PT/OT) ---
        updateProgress(progressValue, "AI Running: Vision, F2F, and PT/OT Extraction...");
        
        const [rawExtraction, f2fSummaryText, ptOtResult] = await Promise.all([
            callGeminiVisionMulti(fileDataArray), // Diagnosis
            callGeminiF2FSummary(fileDataArray),  // F2F
            runPtOtExtraction(fileDataArray)      // PT/OT (New)
        ]);

        // --- STEP 3: AUDIT DIAGNOSES ---
        updateProgress(progressValue, "AI Auditor: Validating ICD-10 Rules...");
        const finalAuditJson = await callGeminiAuditor(rawExtraction);

        CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

        // --- STEP 4: DISPLAY RESULTS ---
        // 1. Diagnosis JSON
        let prettyJson = finalAuditJson;
        try {
            const cleanJson = finalAuditJson
                .replace(/```json/g, "")
                .replace(/```/g, "")
                .trim();
            prettyJson = JSON.stringify(JSON.parse(cleanJson), null, 4);
        } catch {}

        // 2. PT/OT JSON
        let prettyPtOt = ptOtResult;
        try {
             const cleanPtOt = ptOtResult.replace(/```json/g, "").replace(/```/g, "").trim();
             prettyPtOt = JSON.stringify(JSON.parse(cleanPtOt), null, 4);
        } catch {}

        jsonOutput.value = prettyJson;
        f2fOutput.value = f2fSummaryText;
        ptOtOutput.value = prettyPtOt; // Display PT/OT
        
        resultArea.style.display = "none";
        // display block of this button saveBtn
        document.getElementById("saveBtn").style.display = "block";


        // ‚úÖ Finish progress
        stopAutoProgress(100, "Complete");

        setTimeout(() => {
            document.getElementById("mainControls").style.display = "none";
        }, 500);

        showStatus("‚úÖ Analysis Complete.", false);

    } catch (error) {
        console.error(error);
        stopAutoProgress(progressValue, "Failed");
        showStatus("‚ùå " + error.message, true);

    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerText = "Analyze Documents";
        enableUploadUI();
    }

}

/* =========================================================
   SAVE LOGIC (JSON + F2F + PT/OT + FILES)
   ========================================================= */

async function finalizeSave() {
    const saveBtn = document.getElementById("saveBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const f2fOutput = document.getElementById("f2fOutput");
    const ptOtOutput = document.getElementById("ptOtOutput");
    
    try {
        saveBtn.disabled = true;
        
        // --- PART 1: SAVE JSON DATA, F2F, & PT/OT VIA APEX ---
        saveBtn.innerText = "Saving Data...";
        
        // We now pass rawJson, f2f, and ptOtJson
        await sendToSalesforce(
            jsonOutput.value, 
            f2fOutput.value, 
            ptOtOutput.value, 
            currentSessionLogs,
            CACHED_AI_TIME
        );

        // --- PART 2: UPLOAD FILES VIA STANDARD API ---
        if (selectedFiles.length > 0) {
            saveBtn.innerText = `Uploading ${selectedFiles.length} Files...`;
            await saveFilesToSalesforceRecord();
        }
        
        showStatus("‚úÖ Data & Files Saved Successfully!", false);
        saveBtn.innerText = "Saved";
        setTimeout(() => {
        if (IS_PORTAL) {
            console.log("üîÑ Portal User: Refreshing page...");
            window.location.reload(); // Refresh current page
        } else {
            console.log("üöÄ Internal User: Redirecting to Record...");
            window.location.href = `${SF_BASE_URL}/lightning/r/Chart__c/${CHART_ID}/view`;
        }
    }, 1000);
        
        setTimeout(() => { 
            saveBtn.disabled = true; 
            saveBtn.innerText = "Save Data & Files"; 
        }, 3000);

    } catch (e) {
        console.error(e);
        showStatus("‚ùå Save failed: " + e.message, true);
        saveBtn.disabled = false;
        saveBtn.innerText = "Save Data & Files";
    }
}

// 1. Send Data to Custom Apex REST API
async function sendToSalesforce(rawJson, f2fSummary, ptOtJson, aiTimeSeconds) {
    const endpoint =  `${SF_BASE_URL}/services/apexrest/preCoding/ai-result`;
    const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Authorization": "Bearer " + SF_SESSION_ID, "Content-Type": "application/json" },
        body: JSON.stringify({ 
            chartId: CHART_ID, 
            rawJson: rawJson, 
            f2fSummary: f2fSummary, 
            ptOtJson: ptOtJson, // Added PT/OT to payload
            aiTimeSeconds: aiTimeSeconds ,
            aiLogs: aiLogs
        })
    });
    if (!response.ok) throw new Error(await response.text());
}

// 2. Upload Files directly to ContentVersion (Standard Salesforce API)
async function saveFilesToSalesforceRecord() {
    const endpoint = `${SF_BASE_URL}/services/data/v57.0/sobjects/ContentVersion`;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        
        showStatus(`Uploading file ${i+1} of ${selectedFiles.length}: ${file.name}...`, false);
        
        try {
            const fileData = await readFileAsBase64(file); 

            const payload = {
                "Title": file.name,
                "PathOnClient": file.name,
                "VersionData": fileData.base64, 
                "FirstPublishLocationId": CHART_ID, 
                "Origin": "H" 
            };

            const response = await fetch(endpoint, {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + SF_SESSION_ID, 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                const errorCode = errorData[0]?.errorCode || "UNKNOWN";
                const errorMessage = errorData[0]?.message || "Unknown error";
                throw new Error(`Salesforce Error: ${errorCode} - ${errorMessage}`);
            }

            console.log(`‚úÖ Upload Success: ${file.name}`);

        } catch (err) {
            console.error(err);
            showStatus(`‚ùå Failed to upload ${file.name}: ${err.message}`, true);
        }
    }
}

/* =========================================================
   API CALLS (GEMINI)
   ========================================================= */

// --- 1. F2F Summary ---
async function callGeminiF2FSummary(fileDataArray) {
    const f2fPrompt = `
You will receive multiple uploaded clinical documents.
Your job is to carefully READ and UNDERSTAND all documents using full medical reasoning.

Determine whether ANY file represents a clinical:
- Face-to-Face (F2F) visit note, OR
- Encounter note, OR
- Evaluation/assessment visit documentation, OR
- Any clinical document describing a direct meeting with the patient.

Do NOT rely on keywords. Use your understanding of medical documentation structure, tone, content, and intent.
If no such document exists, reply EXACTLY with: "No F2F document found."

If such a document EXISTS:
‚Üí Provide a concise clinical summary UNDER 200 WORDS that includes:
   - Reason for visit
   - Key diagnoses or conditions mentioned
   - Symptoms or significant findings
   - Any plan, recommendations, or follow-up if mentioned

Summarize ONLY what is written. Never fabricate or assume.
    `;

    const parts = [{ text: f2fPrompt }];
    fileDataArray.forEach(f => {
        parts.push({
            inlineData: { mimeType: f.mimeType, data: f.base64 }
        });
    });

    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });

    if (!response.ok) {
        console.warn("F2F Summary failed, returning default message.");
        return "No F2F document found."; 
    }
    const data = await response.json();
    // added code
    currentSessionLogs.push({
        description: "F2F Summary Extraction",
        model: data.modelVersion,
        responseId: data.responseId,
        promptTokens: data.usageMetadata.promptTokenCount,
        totalTokens: data.usageMetadata.totalTokenCount
    });

    // ended here
    let text = data.candidates[0].content.parts[0].text;
    return text.replace(/\*/g, "").trim();
}

// --- 2. Diagnosis Extraction (Raw) ---
async function callGeminiVisionMulti(fileDataArray) {
    const extractionPrompt = `
You are a clinical document extraction auditor.

You MUST perform a FULL scan of ALL uploaded files before generating any output.
Treat ALL files as ONE combined patient chart.

Your job:
- Extract diagnoses EXACTLY as written
- Identify potential primary diagnoses
- Provide justification for each selected diagnosis
- Specify the exact location (page, section, or line reference) where it was found

====================================================
PRIMARY DIAGNOSIS SELECTION RULES
====================================================
1. Identify diagnoses that are clinically primary based on:
   - Reason for visit
   - Acute presentation
   - Major treatment focus
   - Explicitly labeled primary diagnoses
   - Repeated emphasis
2. If the document explicitly labels "Primary Diagnosis", include it.
3. If multiple diagnoses qualify, return ALL potential primary diagnoses.
4. Do NOT assume anything. Use only the document text.

====================================================
DIAGNOSIS EXTRACTION RULES
====================================================
1. Extract ALL diagnoses exactly as written.
2. If an ICD code is present next to a diagnosis, return it exactly.
3. If no ICD code is found, return "".
4. Remove duplicates.
5. All diagnoses NOT classified as primary MUST appear under Secondary Diagnoses.
6. For each diagnosis, return REASON & SOURCE in simple plain text.

====================================================
STRICT OUTPUT FORMAT (Return ONLY this text)
====================================================

SECTION 1: PATIENT DIAGNOSIS DETAILS
Patient Name: <name or NOT FOUND>
Age: <age or NOT FOUND>

Potential Primary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source:
  <why selected>
  <page/section/snippet found>
(Repeat for each)

Secondary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source:
  <snippet or evidence>
  <page/section found>
(Repeat for each)

You MUST read every line of every uploaded file.
Missing any diagnosis is considered an audit failure.
YOU MUST NOT summarize, assume, or fabricate any diagnosis.
Every output must directly come from the uploaded files.
    `;

    const parts = [{ text: extractionPrompt }];
    fileDataArray.forEach(f => {
        parts.push({
            inlineData: { mimeType: f.mimeType, data: f.base64 }
        });
    });

    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });

    if (!response.ok) throw new Error("Vision Step Failed");
    const data = await response.json();

    // added logs part

    currentSessionLogs.push({
        description: "Raw Diagnosis Extraction (Vision)",
        model: data.modelVersion,
        responseId: data.responseId,
        promptTokens: data.usageMetadata.promptTokenCount,
        totalTokens: data.usageMetadata.totalTokenCount
    });
    // ended logs part
    
    return data.candidates[0].content.parts[0].text;
}

// --- 3. PT/OT Extraction (New Integrated Function) ---
async function runPtOtExtraction(fileDataArray) {
    const prompt = `
    Role - You are an expert Medical Data Encoder.

    CRITICAL INSTRUCTION: 

    1. First, determine if any of the uploaded files is a specific Physical Therapy (PT) or Occupational Therapy (OT) Evaluation/Assessment.

    2. If the files are ONLY OASIS forms, physician encounter notes, or discharge summaries WITHOUT a dedicated PT/OT functional assessment section, you MUST return an empty JSON object: {}

    3. DO NOT guess information. If the specific functional levels (Max A, Min A, etc.) are not present in a PT/OT context, return {}.
 

    Task -  Extract functional assessment data from the attached Physical Therapy (PT) or Occupational Therapy (OT) documents and map the values to a specific JSON structure using strict standardization rules.

    1. Value Mapping Logic (Strict)

    You must convert the raw text found in the document (e.g., "Min A", "04", "CGA") into the exact string values listed in the Target Output (Required Value) column below.
    Use the Terms/Codes Found in Doc column to identify the correct match.

    Functional Level    Terms / Codes Found in Doc  Target Output (Required Value)
    6   06, Ind, Independent, I, Safe   "6"
    5   05, Mod I, Modified Independent, MI, Setup/Cleanup  "5"
    4   Walker/Cane used w/o assist, Assist with Device "4"
    4   Sup, Supervision, ST    "4"
    4   SBA, Stand By Assist, SC    "4"
    4   CGA, Contact Guard Assist, Caregiver Assist, Required Assistance    "4"
    3   03, Min A, Minimum Assist, PM, 25%  "3"
    3   Mod A, Moderate Assist, 50% "3"
    2   02, Max A, Max Assistance, SM, 75%  "2"
    1   01, Dep, Dependent, Total Assist, >75%, Unable  "1"
    NT  NT, N/A, Not Attempted, Not Tested  "NT"

    Note:
    If the document uses checkmarks, map the column header (e.g., MIN, MOD, MAX) to the corresponding Target Output.

    2. Extraction Instructions

    Determine Discipline
    Identify whether the document is PT or OT and populate only the relevant fields.

    Find Current Status
    Extract the CURRENT status only.
    Ignore values from Prior Level, Previous, or Goal columns.

    Ambiguity Handling

    If the value is PM, map to "3".

    If the value is SM, map to "2" (unless explicitly labeled Moderate).

    Null Handling

    If a field is not found in the document, exclude it from the JSON or set it to null.

    3. JSON Output Structure

    Return only a valid JSON object using the keys below. Do NOT use markdown code blocks.

    Occupational Therapy (OT) Fields

    (Only populate these if analyzing an OT document)

    Date_of_OT_Eval__c ‚Üí Format: YYYY-MM-DD

    GG_OT_Feeding__c ‚Üí Look for Eating / Feeding

    GG_OT_Oral_Hygiene__c ‚Üí Look for Teeth / Dentures / Oral

    GG_OT_Grooming__c ‚Üí Look for Grooming / Hygiene

    GG_OT_Toilet_Hygiene__c ‚Üí Look for Toileting Hygiene / Clothing Management

    GG_OT_Bathing__c ‚Üí Look for Bathing / Washing Body

    GG_OT_Upper_Body_Dressing__c ‚Üí Look for Upper Body Dressing

    GG_OT_Lower_Body_Dressing__c ‚Üí Look for Lower Body Dressing

    GG_OT_Sock_Shoes__c ‚Üí Look for Footwear / Shoes / Socks

    If combined with Lower Body Dressing, use that score.

    GG_OT_Car_Van__c ‚Üí Look for Car Transfer in OT section

    GG_OT_Toilet_Transfer__c ‚Üí Look for Toilet Transfer in OT section

    Physical Therapy (PT) Fields

    (Only populate these if analyzing a PT document)

    GG_PT_Sit_Stand__c ‚Üí Look for Sit to Stand transfer

    GG_PT_Bed_Wheelchair__c ‚Üí Look for Bed to Chair / Wheelchair transfer

    GG_PT_Wheelchair_Bed__c ‚Üí Look for Wheelchair to Bed transfer

    If not distinct, use Bed_Wheelchair value.

    GG_PT_Car_Van__c ‚Üí Look for Car Transfer

    GG_PT_Toilet_Transfer__c ‚Üí Look for Toilet Transfer / Commode

    GG_PT_Bathing__c ‚Üí Look for Tub / Shower Transfer

    GG_PT_Level_10_Feet__c ‚Üí Look for Ambulation / Gait ‚Äì 10 ft

    GG_PT_Level_50_Feet__c ‚Üí Look for Ambulation / Gait ‚Äì 50 ft

    GG_PT_Level_150_Feet__c ‚Üí Look for Ambulation / Gait ‚Äì 150 ft

    GG_PT_Unlevel__c ‚Üí Look for Uneven Surfaces

    GG_PT_1_Step__c ‚Üí Look for 1 Step / Curb

    GG_PT_4_Steps__c ‚Üí Look for 4 Steps

    GG_PT_12_Steps__c ‚Üí Look for 12 Steps / Full Flight

    General Fields (All Documents)

    Complete_PT_OT_Eval__c ‚Üí Always set to "Yes"

    Date_of_PT_OT_Eval__c ‚Üí Date of evaluation (YYYY-MM-DD)

    Bed_Mobility__c ‚Üí Look for Rolling Left / Right

    Transfer__c ‚Üí Look for Supine to Sit / Sit to Supine

    Gait__c ‚Üí Look for general ambulation if distances are not listed

    Wheelchair_Mobility__c ‚Üí Look for Wheelchair use / propulsion

     Other__c ‚Üí Look for Unlevel or Uneven Surfaces (Level / Unlevel / Uneven / Uneven surface / Walk on uneven surfaces and Populate this field using the same Value Mapping Logic defined above.)
    `;

    const parts = [{ text: prompt }];
    fileDataArray.forEach(f => {
        parts.push({ inlineData: { mimeType: f.mimeType, data: f.base64 } });
    });

    const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: parts }] })
    });

    if (!response.ok) {
        console.warn("PT/OT Extraction failed");
        return "{}";
    }
    const data = await response.json();
    // logs

    currentSessionLogs.push({
        description: "PT/OT Functional Assessment",
        model: data.modelVersion,
        responseId: data.responseId,
        promptTokens: data.usageMetadata.promptTokenCount,
        totalTokens: data.usageMetadata.totalTokenCount
    });
    
    // ended
    return data.candidates[0].content.parts[0].text;
}

// --- 4. RAG Auditor ---
async function callGeminiAuditor(extractedText) {
    const auditorSystemPrompt = `
You are an Expert ICD-10-CM Medical Coding Auditor and Compliance Officer.
Your task is to perform a complete audit and produce a correct, conflict-free,
clinically validated, mandatory-rule-compliant, properly sequenced ICD-10-CM
diagnostic output.

You have FOUR authoritative knowledge sources:
1. File A ‚Äî ICD-10-CM Excel Database (valid codes + official descriptions)
2. File B ‚Äî ICD-10-CM Tabular List PDF (Includes, Excludes1, Excludes2, Code First,
   Use Additional Code, sequencing rules)
3. File C ‚Äî ICD-10 Potential Primary Diagnosis Codes
   (Only these clinically valid codes can be potential primary.)
4. File D ‚Äî Coding Tip File
   (Guidelines, overrides, use additional code, sequencing adjustments.)

======================================================================
STRICT RULE ‚Äî POTENTIAL PRIMARY LOGIC
======================================================================
A diagnosis can be "potentialPrimary" ONLY IF:
‚Ä¢ It appears under ‚ÄúPotential Primary Diagnosis‚Äù in the input AND
‚Ä¢ The ICD exists in File C AND
‚Ä¢ Clinical Group (from File C) is NOT blank

Otherwise ‚Üí potentialPrimary MUST be false.

potentialPrimary value MUST always be boolean (true or false).

======================================================================
GLOBAL RULE ‚Äî EVERY CODE MUST BE CHECKED AGAINST ALL GUIDELINES
======================================================================
For EACH ICD code you output, YOU MUST:
‚Ä¢ Validate the ICD from File A (code + description)
‚Ä¢ Apply ALL applicable Tabular List rules from File B:
  - Excludes1 ‚Üí DROP conflicting codes
  - Excludes2 ‚Üí allow but handle correctly
  - Code First ‚Üí ensure parent condition appears before this code
  - Use Additional Code ‚Üí add the required secondary code
‚Ä¢ Apply Coding Tips from File D when relevant
‚Ä¢ Apply sequencing rules EXACTLY as mandated
‚Ä¢ Remove any ICD code that violates a rule or creates a contradiction

EVERY RULE MUST BE APPLIED CODE BY CODE, NOT GLOBALLY.

======================================================================
IMPORTANT ‚Äî ABOUT REASON & SOURCE
======================================================================
For each diagnosis in the input text:
‚Ä¢ Extract the exact "Reason & Source" block
‚Ä¢ The returned JSON must include reasonSource EXACTLY as provided
‚Ä¢ Keep reasonSource in simple plain text
‚Ä¢ Do NOT use single quotes or double quotes inside reasonSource

If YOU add an ICD due to:
‚Ä¢ Code First rule
‚Ä¢ Use Additional Code rule
‚Ä¢ Coding Tip rule
‚Ä¢ Sequencing adjustment

‚Üí You MUST generate a NEW reasonSource explaining why the code was added.

NO ICD should be returned without a reasonSource.

======================================================================
FINAL OUTPUT FORMAT (STRICT JSON ‚Äî DO NOT CHANGE FIELD NAMES)
======================================================================

[
  {
    "code": "<ICD from File A>",
    "reasonSource": "<Original text OR rule-based explanation in simple plain text>",
    "potentialPrimary": true or false
  }
]

======================================================================
PROCESS STEPS YOU MUST FOLLOW
======================================================================

STEP 1 ‚Äî Normalize & Validate Diagnoses
‚Ä¢ Extract all diagnoses and ICD codes
‚Ä¢ Validate each ICD using File A
‚Ä¢ Assign correct ICD where missing
‚Ä¢ DROP invalid, incomplete, or conflicting ICDs
‚Ä¢ Ensure potentialPrimary is always true or false
‚Ä¢ If undeterminable ‚Üí default to false

STEP 2 ‚Äî Apply Potential Primary Validation

STEP 3 ‚Äî Apply Excludes1 (DROP conflicting codes)

STEP 4 ‚Äî Apply Excludes2 rules if relevant

STEP 5 ‚Äî Apply Coding Tips from File D (MANDATORY for each code)

STEP 6 ‚Äî Apply CODE FIRST rules (insert required parent ICDs)

STEP 7 ‚Äî Apply USE ADDITIONAL CODE rules (insert required secondary ICDs)

STEP 8 ‚Äî Final compliance validation, sequencing correction,
          and conflict removal

======================================================================
INPUT DIAGNOSES TO AUDIT:
======================================================================

<medicalExtractText>
    `;

    const userPrompt = `INPUT:\n${extractedText}`;

    let tools = [];

if (VECTOR_STORE_ID) {
  tools = [
    {
      file_search: {
        vector_store_ids: [VECTOR_STORE_ID]
       
      }
    }
  ];
}

    const response = await fetch(`${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            system_instruction: { parts: [{ text: auditorSystemPrompt }] },
            contents: [{ parts: [{ text: userPrompt }] }],
           
        })
    });

    if (!response.ok) throw new Error("Audit Step Failed");
    const data = await response.json();
//added   
    currentSessionLogs.push({
        description: "ICD-10 Compliance Audit (RAG)",
        model: data.modelVersion,
        responseId: data.responseId,
        promptTokens: data.usageMetadata.promptTokenCount,
        totalTokens: data.usageMetadata.totalTokenCount
    });

    // ended
    return data.candidates[0].content.parts[0].text;
}

/* =========================================================
   HELPERS
   ========================================================= */

function showStatus(message, isError = false) {
    const status = document.getElementById("status");
    status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
}

function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
            mimeType: file.type,
            base64: reader.result.split(",")[1],
            name: file.name
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}
        </script>
    </body>
</html>
